<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --primary-color: #06C755; }
    body { font-family: -apple-system, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; color: #333; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }
    
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
    input, select, textarea { 
      width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; 
      border-radius: 8px; box-sizing: border-box; font-size: 16px; 
    }
    textarea { height: 80px; resize: none; }
    
    button { 
      width: 100%; padding: 14px; margin-top: 25px; font-size: 18px; font-weight: bold;
      background-color: var(--primary-color); color: white; border: none; border-radius: 8px; 
      cursor: pointer; transition: background 0.3s;
    }
    button:disabled { background-color: #ccc; }
    .profile-info { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 14px; }
    .profile-info img { width: 40px; border-radius: 50%; }
  </style>
</head>
<body>

<div class="card">
  <h2>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h2>
  
  <div id="userProfile" class="profile-info" style="display:none;">
    <img id="userImg" src="" alt="profile">
    <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</span>
  </div>

  <form id="repairForm">
    <label>‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <input type="text" id="department" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å" required>
    
    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
    <input type="tel" id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" required>
    
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
      <select id="device" required>
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå --</option>
        <option value="Computer AIO">Computer AIO</option>
        <option value="Laptop">Laptop</option>
        <option value="Network">Network</option>
        <option value="ZOOM">ZOOM</option>
        <option value="UC-Phone">UC-Phone</option>
        <option value="CCTV-FingerPrint scan">CCTV-FingerPrint scan</option>
        <option value="Others">Others</option>
      </select>
    
    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
    <textarea id="issue" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô" required></textarea>
    
    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
    <select id="priority" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô --</option>
      <option value="‡∏™‡∏π‡∏á">üî¥ ‡∏™‡∏π‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</option>
      <option value="‡∏Å‡∏•‡∏≤‡∏á">üü° ‡∏Å‡∏•‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</option>
      <option value="‡∏ï‡πà‡∏≥">üü¢ ‡∏ï‡πà‡∏≥ (‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
    </select>
    
    <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
    <input type="file" id="imageFile" accept="image/jpeg,image/png">
    
    <button type="submit" id="submitBtn">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
  </form>
</div>

<script>
const LIFF_ID = "2008875334-eZXiyz43"; 
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwm4TWCHwWMruixhziJS2O0IucQXYOzFPrVPuTNab0Pvy-bUF_ZBX-ABMILPI5vd0m5/exec";

let userProfile = null;

async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      userProfile = await liff.getProfile();
      document.getElementById("userProfile").style.display = "flex";
      document.getElementById("userImg").src = userProfile.pictureUrl;
      document.getElementById("userName").innerText = "‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: " + userProfile.displayName;
    }
  } catch (err) {
    console.error("LIFF Init Error:", err);
  }
}

function resizeImage(file, maxSize = 1024) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let width = img.width;
        let height = img.height;
        if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
        else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
        canvas.width = width;
        canvas.height = height;
        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL("image/jpeg", 0.8).split(",")[1]);
      };
    };
  });
}

document.getElementById("repairForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const submitBtn = document.getElementById("submitBtn");
  
  if (!userProfile) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile ‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  let imageBase64 = "";
  const fileInput = document.getElementById("imageFile");
  if (fileInput.files.length > 0) {
    imageBase64 = await resizeImage(fileInput.files[0]);
  }

  const payload = {
    uid: userProfile.userId,
    displayName: userProfile.displayName,
    department: document.getElementById("department").value,
    phone: document.getElementById("phone").value,
    device: document.getElementById("device").value,
    issue: document.getElementById("issue").value,
    priority: document.getElementById("priority").value,
    imageBase64: imageBase64
  };

  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "no-cors", // ‡πÉ‡∏ä‡πâ no-cors ‡∏´‡∏≤‡∏Å Google Script ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS ‡πÑ‡∏ß‡πâ
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ä‡πâ no-cors ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡πÜ 
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à Google Script ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
    alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    liff.closeWindow();
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    submitBtn.disabled = false;
    submitBtn.innerText = "‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°";
  }
});

initLIFF();
</script>
</body>
</html>
