<script>
    const LIFF_ID = "2008875334-eZXiyz43"; 
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwYgKGmjUTXFD4zE984NIuGwydvc9DJuEEdocN6RdqEszAkd6IE34VVs6iLE_kemZok/exec"; 
    const REVIEW_LIFF_URL = "https://liff.line.me/2008875334-d6l72Uox"; 

    // ... ฟังก์ชัน main() และการดึง Profile คงเดิม ...

    document.getElementById('repairForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSub');
        btn.disabled = true;
        document.getElementById('loading').style.display = 'block';

        const profile = await liff.getProfile();
        let base64 = "";
        const file = document.getElementById('imageFile').files[0];
        if (file) {
            base64 = await new Promise((res) => {
                const r = new FileReader();
                r.onload = () => res(r.result.split(',')[1]);
                r.readAsDataURL(file);
            });
        }

        const payload = {
            uid: profile.userId,
            displayName: profile.displayName,
            room: document.getElementById('room').value,
            phone: document.getElementById('phone').value,
            category: document.getElementById('category').value,
            issue: document.getElementById('issue').value,
            priority: document.getElementById('priority').value,
            imageBase64: base64
        };

        try {
            const response = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
            const resData = await response.json();

            if (resData.result === "ok") {
                if (liff.isInClient()) {
                    await liff.sendMessages([{
                        "type": "flex",
                        "altText": "รับเรื่องแจ้งซ่อมแล้ว " + resData.ticketId,
                        "contents": {
                            "type": "bubble",
                            "header": {
                                "type": "box",
                                "layout": "vertical",
                                "backgroundColor": "#000080",
                                "contents": [
                                    { "type": "text", "text": "บันทึกสำเร็จ", "color": "#FFFFFF", "weight": "bold", "size": "md" }
                                ]
                            },
                            "body": {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "md",
                                "contents": [
                                    { "type": "text", "text": "หมายเลข: " + resData.ticketId, "weight": "bold", "size": "xl", "color": "#000080" },
                                    { "type": "text", "text": "รบกวนให้คะแนนเมื่อบริการเสร็จสิ้น", "size": "xs", "color": "#888888" },
                                    {
                                        "type": "box",
                                        "layout": "horizontal",
                                        "margin": "lg",
                                        "spacing": "xs",
                                        "contents": [1, 2, 3, 4, 5].map(s => ({
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "⭐",
                                                    "size": "xl",
                                                    "align": "center",
                                                    "gravity": "center",
                                                    "action": {
                                                        "type": "uri",
                                                        "label": "star",
                                                        "uri": REVIEW_LIFF_URL + "?row=" + resData.row + "&score=" + s
                                                    }
                                                }
                                            ],
                                            "backgroundColor": "#F0F0F0",
                                            "cornerRadius": "md",
                                            "paddingAll": "sm"
                                        }))
                                    }
                                ]
                            }
                        }
                    }]);
                }
                setTimeout(() => { liff.closeWindow(); }, 500);
            }
        } catch (err) {
            alert("Error: " + err.message);
            btn.disabled = false;
            document.getElementById('loading').style.display = 'none';
        }
    });
    main();
</script>
