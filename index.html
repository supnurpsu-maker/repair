<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>แจ้งซ่อมคอมพิวเตอร์</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>แบบฟอร์มแจ้งซ่อมคอมพิวเตอร์</h2>
  <form id="repairForm">
    <label>แผนก / ฝ่าย
      <input type="text" id="department" required>
    </label>
    <label>เบอร์โทร
      <input type="text" id="phone" required>
    </label>
    <label>อุปกรณ์
      <input type="text" id="device" required>
    </label>
    <label>ปัญหา
      <textarea id="issue" required></textarea>
    </label>
    <label>ความเร่งด่วน
      <select id="priority" required>
        <option value="">เลือกความเร่งด่วน</option>
        <option value="สูง">สูง</option>
        <option value="ปานกลาง">ปานกลาง</option>
        <option value="ต่ำ">ต่ำ</option>
      </select>
    </label>
    <label>แนบรูป (ถ้ามี)
      <input type="file" id="imageFile" accept="image/*">
    </label>
    <button type="submit">ส่งแจ้งซ่อม</button>
  </form>

  <script>
    let profile;

    async function initLIFF() {
      try {
        await liff.init({ liffId: "2008875334-eZXiyz43" });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        profile = await liff.getProfile();
        console.log("Profile loaded:", profile);
      } catch (err) {
        console.error("LIFF init error:", err);
        alert("เกิดข้อผิดพลาดในการโหลด LIFF: " + err.message);
      }
    }

    initLIFF();

    document.getElementById("repairForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      if (!profile) {
        alert("ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่");
        return;
      }

      const department = document.getElementById("department").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const device = document.getElementById("device").value.trim();
      const issue = document.getElementById("issue").value.trim();
      const priority = document.getElementById("priority").value;

      if (!department || !phone || !device || !issue || !priority) {
        alert("กรุณากรอกข้อมูลให้ครบทุกช่อง");
        return;
      }

      // อ่านไฟล์รูปถ้ามี
      let imageBase64 = "";
      const fileInput = document.getElementById("imageFile");
      if(fileInput.files.length > 0){
        const file = fileInput.files[0];
        const reader = new FileReader();
        await new Promise(resolve => {
          reader.onload = () => { imageBase64 = reader.result.split(',')[1]; resolve(); };
          reader.readAsDataURL(file);
        });
      }

      const data = {
        uid: profile.userId,
        displayName: profile.displayName,
        department,
        phone,
        device,
        issue,
        priority,
        imageBase64
      };

      console.log("Data to send:", data);

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxA8L606bfUd91Gbp6q3Av6VcOAoDOUm6cKNWdU8d5MAM_u8hCYfqro3MnLhRZBssRf6w/exec", {
          method: "POST",
          body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log("Response from Web App:", result);
        alert("ส่งข้อมูลเรียบร้อยแล้ว");
        liff.closeWindow(); // ปิด LIFF หลังส่ง
      } catch (err) {
        console.error("Fetch error:", err);
        alert("เกิดข้อผิดพลาดในการส่งข้อมูล: " + err.message);
      }
    });
  </script>
</body>
</html>
