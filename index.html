<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IT Support Repair Form</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --primary-color: #06C755; --bg-color: #f5f5f5; }
    body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; }
    .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 500px; margin: auto; }
    h2 { text-align: center; color: var(--primary-color); margin-top: 0; }
    
    .profile-info { display: flex; align-items: center; gap: 12px; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
    .profile-info img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .profile-info span { font-size: 14px; font-weight: 600; color: #555; }

    label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #444; }
    input, select, textarea { 
      width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; 
      border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
    }
    textarea { height: 90px; resize: none; }
    
    button { 
      width: 100%; padding: 15px; margin-top: 25px; font-size: 18px; font-weight: bold;
      background-color: var(--primary-color); color: white; border: none; border-radius: 8px; 
      cursor: pointer; transition: 0.3s;
    }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="card">
  <h2>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° IT Support</h2>
  
  <div id="userProfile" class="profile-info" style="display:none;">
    <img id="userImg" src="" alt="profile">
    <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
  </div>

  <form id="repairForm">
    <label>‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <input type="text" id="department" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å" required>
    
    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
    <input type="tel" id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08XXXXXXXX" required>
    
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
     <select id="device" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
      <option value="Computer AIO">Computer AIO</option>
      <option value="Laptop">Laptop</option>
      <option value="Network">Network</option>
      <option value="PSU Passport">PSU Passport</option>
      <option value="ZOOM/UC-Phone">ZOOM/UC-Phone</option>
      <option value="CCTV/FingerPrint Scan">CCTV/FingerPrint Scan</option>
      <option value="Others">Others</option>
    </select>
    
    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
    <textarea id="issue" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô" required></textarea>
    
    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
    <select id="priority" required>
      <option value="‡∏™‡∏π‡∏á">üî¥ ‡∏™‡∏π‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</option>
      <option value="‡∏Å‡∏•‡∏≤‡∏á">üü° ‡∏Å‡∏•‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</option>
      <option value="‡∏ï‡πà‡∏≥">üü¢ ‡∏ï‡πà‡∏≥ (‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
    </select>
    
    <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
    <input type="file" id="imageFile" accept="image/*">
    
    <button type="submit" id="submitBtn">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
  </form>
</div>

<script>
// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
const LIFF_ID_MAIN = "2008875334-eZXiyz43"; 
const LIFF_ID_REVIEW = "2008875334-d6l72Uox"; 
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwRt9NnmJuG0eoSN4y_NApv-UPRH5XCkWvBY76mQDGDUW3nsDU3XsDD6TxZsQcPc7GU/exec";
// ------------------------------

let profile = null;

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID_MAIN });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      profile = await liff.getProfile();
      document.getElementById("userProfile").style.display = "flex";
      document.getElementById("userImg").src = profile.pictureUrl;
      document.getElementById("userName").innerText = "‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: " + profile.displayName;
    }
  } catch (err) { console.error("LIFF Init Error:", err); }
}

// ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
function resizeImg(file) {
  return new Promise(res => {
    const r = new FileReader(); r.readAsDataURL(file);
    r.onload = e => {
      const img = new Image(); img.src = e.target.result;
      img.onload = () => {
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");
        const maxSize = 800;
        let w = img.width, h = img.height;
        if (w > h && w > maxSize) { h *= maxSize / w; w = maxSize; }
        else if (h > maxSize) { w *= maxSize / h; h = maxSize; }
        c.width = w; c.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        res(c.toDataURL("image/jpeg", 0.8).split(",")[1]);
      }
    }
  });
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
document.getElementById("repairForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = document.getElementById("submitBtn");
  if (!profile) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile");

  btn.disabled = true;
  btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  let imgBase64 = "";
  const file = document.getElementById("imageFile").files[0];
  if (file) imgBase64 = await resizeImg(file);

  const payload = {
    uid: profile.userId,
    displayName: profile.displayName,
    department: document.getElementById("department").value,
    phone: document.getElementById("phone").value,
    device: document.getElementById("device").value,
    issue: document.getElementById("issue").value,
    priority: document.getElementById("priority").value,
    imageBase64: imgBase64
  };

  try {
    const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.result === "ok") {
      const tid = result.ticketId;
      const row = result.row;
      const pending = result.pending;
      const reviewUrl = `https://liff.line.me/${LIFF_ID_REVIEW}?row=${row}`;
      
      // ‡∏™‡πà‡∏á Flex Message ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
      if (liff.getContext().type !== "none") {
        await liff.sendMessages([{
          "type": "flex",
          "altText": "‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° " + tid,
          "contents": {
            "type": "bubble",
            "header": { 
              "type": "box", "layout": "vertical", "backgroundColor": "#06C755", 
              "contents": [{
                "type": "box", "layout": "horizontal", "contents": [
                  { "type": "text", "text": "‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß", "color": "#ffffff", "weight": "bold", "flex": 4 },
                  { "type": "text", "text": tid, "color": "#ffffff", "size": "xs", "align": "end", "gravity": "center", "flex": 2 }
                ]
              }]
            },
            "body": { 
              "type": "box", "layout": "vertical", "contents": [
                { 
                  "type": "box", "layout": "vertical", "backgroundColor": "#f0f0f0", "paddingAll": "md", "cornerRadius": "md", 
                  "contents": [
                    { "type": "text", "text": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "weight": "bold", "color": "#0000FF", "size": "sm" },
                    { "type": "text", "text": "‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ: " + pending + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "size": "xs", "margin": "xs", "color": "#666666" }
                  ]
                },
                { "type": "text", "text": "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "weight": "bold", "size": "sm", "margin": "lg" },
                { 
                  "type": "box", "layout": "vertical", "margin": "md", "spacing": "sm", 
                  "contents": [
                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "color": "#aaaaaa", "size": "xs", "flex": 2 }, { "type": "text", "text": payload.device, "size": "xs", "flex": 5, "wrap": true }]},
                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", "color": "#aaaaaa", "size": "xs", "flex": 2 }, { "type": "text", "text": payload.issue, "size": "xs", "flex": 5, "wrap": true }]}
                  ]
                },
                { "type": "separator", "margin": "xl" },
                { "type": "text", "text": "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°", "align": "center", "size": "xs", "margin": "md", "color": "#aaaaaa" },
                { 
                  "type": "box", "layout": "horizontal", "margin": "md", 
                  "contents": [
                    { "type": "text", "text": "‚≠ê", "size": "xl", "align": "center", "action": { "type": "uri", "uri": reviewUrl + "&score=1" }},
                    { "type": "text", "text": "‚≠ê", "size": "xl", "align": "center", "action": { "type": "uri", "uri": reviewUrl + "&score=2" }},
                    { "type": "text", "text": "‚≠ê", "size": "xl", "align": "center", "action": { "type": "uri", "uri": reviewUrl + "&score=3" }},
                    { "type": "text", "text": "‚≠ê", "size": "xl", "align": "center", "action": { "type": "uri", "uri": reviewUrl + "&score=4" }},
                    { "type": "text", "text": "‚≠ê", "size": "xl", "align": "center", "action": { "type": "uri", "uri": reviewUrl + "&score=5" }}
                  ]
                }
              ]
            }
          }
        }]);
      }
      alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° " + tid + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
      liff.closeWindow();
    } else {
      throw new Error(result.message);
    }
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
    btn.disabled = false;
    btn.innerText = "‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°";
  }
});

initLIFF();
</script>
</body>
</html>
