<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --primary-color: #06C755; --error-color: #ff4d4f; }
    body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; margin: 0; padding: 15px; }
    .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 500px; margin: auto; }
    h2 { text-align: center; color: var(--primary-color); margin-top: 0; }
    
    .profile-info { display: flex; align-items: center; gap: 12px; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 20px; }
    .profile-info img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .profile-info span { font-size: 14px; font-weight: 600; color: #555; }

    label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #444; }
    input, select, textarea { 
      width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; 
      border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-color); }
    textarea { height: 90px; resize: none; }
    
    button { 
      width: 100%; padding: 15px; margin-top: 25px; font-size: 18px; font-weight: bold;
      background-color: var(--primary-color); color: white; border: none; border-radius: 8px; 
      cursor: pointer; transition: 0.3s;
    }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .hint { font-size: 12px; color: #888; margin-top: 4px; }
  </style>
</head>
<body>

<div class="card">
  <h2>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° IT Support</h2>
  
  <div id="userProfile" class="profile-info" style="display:none;">
    <img id="userImg" src="" alt="profile">
    <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
  </div>

  <form id="repairForm">
    <label>‡∏´‡πâ‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <input type="text" id="department" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å" required>
    
    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
    <input type="tel" id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08XXXXXXXX" required>
    
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
    <select id="device" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå --</option>
      <option value="Computer AIO">Computer AIO</option>
      <option value="Laptop">Laptop</option>
      <option value="Network">Network</option>
      <option value="ZOOM">ZOOM</option>
      <option value="UC-Phone">UC-Phone</option>
      <option value="CCTV-FingerPrint scan">CCTV-FingerPrint scan</option>
      <option value="Others">Others</option>
    </select>
    
    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
    <textarea id="issue" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô" required></textarea>
    
    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
    <select id="priority" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô --</option>
      <option value="‡∏™‡∏π‡∏á">üî¥ ‡∏™‡∏π‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</option>
      <option value="‡∏Å‡∏•‡∏≤‡∏á">üü° ‡∏Å‡∏•‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</option>
      <option value="‡∏ï‡πà‡∏≥">üü¢ ‡∏ï‡πà‡∏≥ (‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
    </select>
    
    <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
    <input type="file" id="imageFile" accept="image/jpeg,image/png">
    <p class="hint">*‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û .jpg, .png</p>
    
    <button type="submit" id="submitBtn">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
  </form>
</div>

<script>
// --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ‡πÅ‡∏•‡∏∞ Web App ---
const LIFF_ID = "2008875334-eZXiyz43"; 
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwm4TWCHwWMruixhziJS2O0IucQXYOzFPrVPuTNab0Pvy-bUF_ZBX-ABMILPI5vd0m5/exec";

let userProfile = null;

async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      userProfile = await liff.getProfile();
      document.getElementById("userProfile").style.display = "flex";
      document.getElementById("userImg").src = userProfile.pictureUrl;
      document.getElementById("userName").innerText = "‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: " + userProfile.displayName;
    }
  } catch (err) {
    console.error("LIFF Error:", err);
  }
}

function resizeImage(file, maxSize = 1024) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let width = img.width, height = img.height;
        if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
        else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
        canvas.width = width; canvas.height = height;
        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL("image/jpeg", 0.8).split(",")[1]);
      };
    };
  });
}

document.getElementById("repairForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const submitBtn = document.getElementById("submitBtn");
  if (!userProfile) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile");

  submitBtn.disabled = true;
  submitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  let imageBase64 = "";
  const fileInput = document.getElementById("imageFile");
  if (fileInput.files.length > 0) {
    imageBase64 = await resizeImage(fileInput.files[0]);
  }

  const payload = {
    uid: userProfile.userId,
    displayName: userProfile.displayName,
    department: document.getElementById("department").value,
    phone: document.getElementById("phone").value,
    device: document.getElementById("device").value,
    issue: document.getElementById("issue").value,
    priority: document.getElementById("priority").value,
    imageBase64: imageBase64
  };

  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await response.json();

    if (result.result === "ok") {
      // ‡∏™‡πà‡∏á Flex Message ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
      if (liff.getContext().type !== "none") {
        await liff.sendMessages([{
          "type": "flex",
          "altText": "‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
          "contents": {
            "type": "bubble",
            "size": "mega",
            "header": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "weight": "bold", "color": "#FFFFFF", "size": "lg" }], "backgroundColor": "#06C755" },
            "body": { "type": "box", "layout": "vertical", "contents": [
              { "type": "text", "text": "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "weight": "bold", "size": "md", "margin": "md" },
              { "type": "separator", "margin": "md" },
              { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [{ "type": "text", "text": "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": payload.device, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }]},
                { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [{ "type": "text", "text": "‡∏õ‡∏±‡∏ç‡∏´‡∏≤", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": payload.issue, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }]},
                { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [{ "type": "text", "text": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": payload.priority, "wrap": true, "color": payload.priority === '‡∏™‡∏π‡∏á' ? "#FF0000" : "#666666", "size": "sm", "flex": 5, "weight": "bold" }]}
              ]}
            ]},
            "footer": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö: " + payload.phone, "size": "xs", "color": "#888888", "align": "center" }] }
          }
        }]);
      }
      alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
      liff.closeWindow();
    } else {
      throw new Error(result.message);
    }
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    submitBtn.disabled = false;
    submitBtn.innerText = "‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°";
  }
});

initLIFF();
</script>
</body>
</html>
