<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Management</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #000080; --bg: #f4f7f9; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
        .role-badge { background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 10px; font-size: 11px; }
        .job-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 6px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .status-pending { border-left-color: #f1c40f; }
        .status-process { border-left-color: #000080; }
        .status-done { border-left-color: #28a745; }
        .filter-section { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chip { padding: 6px 15px; background: white; border-radius: 20px; border: 1px solid #ddd; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-update { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; margin-top: 10px; font-weight: 600; }
        #loader { text-align: center; padding: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
        <span id="adminInfo" class="role-badge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</span>
    </div>

    <div id="filterWrapper" style="display:none;">
        <div class="filter-section" id="filterArea">
            <div class="chip active" onclick="filterJobs('ALL', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
    </div>

    <div id="loader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="jobList"></div>
</div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbwpkvMh9TOKYooLX63iFqafzYROH3N0zxWMl-q5xWoDZCj2K-brBacuuD9AE5lCwrYq/exec";
    const LIFF_ID = "2008875334-VPUmuC8D";
    let allJobs = [];
    let myRole = ""; 
    let myDept = "";

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            const profile = await liff.getProfile();
            
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
            const roleRes = await fetch(`${URL_GAS}?action=getAdminRole&uid=${profile.userId}`);
            const roleData = await roleRes.json();
            myRole = roleData.role;
            myDept = roleData.dept;

            document.getElementById('adminInfo').innerText = `‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${myRole} (${myDept || '‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å'})`;

            // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super Admin ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å
            if (myRole === "SUPER_ADMIN") {
                document.getElementById('filterWrapper').style.display = 'block';
                await loadPrefixes();
            }

            // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô
            await loadAllJobs();
        } catch (e) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: " + e);
        }
    }

    async function loadPrefixes() {
        const res = await fetch(`${URL_GAS}?action=getPrefixes`);
        const prefixes = await res.json();
        const area = document.getElementById('filterArea');
        prefixes.forEach(p => {
            const div = document.createElement('div');
            div.className = 'chip';
            div.innerText = p;
            div.onclick = (e) => filterJobs(p, e.target);
            area.appendChild(div);
        });
    }

    async function loadAllJobs() {
        document.getElementById('loader').style.display = 'block';
        const res = await fetch(`${URL_GAS}?action=getAllJobs`);
        allJobs = await res.json();
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (myRole === "DEPT_ADMIN") {
            const deptJobs = allJobs.filter(j => j.ticketId.startsWith(myDept + "#"));
            renderJobs(deptJobs);
        } else {
            renderJobs(allJobs); // Super Admin ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Default
        }
        document.getElementById('loader').style.display = 'none';
    }

    function renderJobs(jobs) {
        const container = document.getElementById('jobList');
        container.innerHTML = "";
        if(jobs.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</p>";
            return;
        }

        jobs.reverse().forEach(job => {
            let sClass = job.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ? "status-done" : (job.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ? "status-process" : "status-pending");
            const card = document.createElement('div');
            card.className = `job-card ${sClass}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong style="color:var(--primary); font-size:18px;">${job.ticketId}</strong>
                    <span style="font-size:12px; color:#999;">${job.time}</span>
                </div>
                <div style="margin:10px 0; font-size:14px;">
                    üìç <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${job.room}<br>
                    üë§ <b>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</b> ${job.name}<br>
                    üîß <b>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${job.issue}
                </div>
                <div style="display:flex; gap:8px;">
                    <select id="stat-${job.row}" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;">
                        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${job.status == '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>
                    <input type="text" id="admin-${job.row}" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á" value="${job.admin || ''}">
                </div>
                <button class="btn-update" onclick="updateJob(${job.row})">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
            `;
            container.appendChild(card);
        });
    }

    function filterJobs(p, el) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        const filtered = (p === 'ALL') ? allJobs : allJobs.filter(j => j.ticketId.startsWith(p + "#"));
        renderJobs(filtered);
    }

    async function updateJob(row) {
        const s = document.getElementById(`stat-${row}`).value;
        const a = document.getElementById(`admin-${row}`).value;
        const res = await fetch(`${URL_GAS}?action=adminUpdate&row=${row}&status=${encodeURIComponent(s)}&admin=${encodeURIComponent(a)}`);
        if (await res.text() === "SUCCESS") {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
            loadAllJobs();
        }
    }

    init();
</script>
</body>
</html>
