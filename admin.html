<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #000080; --accent: #FBCEB1; --bg: #f4f7fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .filter-section { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        select#prefixFilter { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        
        .job-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); position: relative; border-left: 6px solid #ccc; }
        .priority-‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î { border-left-color: #ff4d4d; }
        .priority-‡∏î‡πà‡∏ß‡∏ô { border-left-color: #ffa500; }
        .priority-‡∏õ‡∏Å‡∏ï‡∏¥ { border-left-color: #2ecc71; }
        
        .ticket-id { font-weight: bold; color: var(--primary); font-size: 0.9em; }
        .status-badge { float: right; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-pending { background: #fff5f5; color: #ff4d4d; border: 1px solid #ff4d4d; }
        .badge-process { background: #e8f0fe; color: #000080; border: 1px solid #000080; }
        
        .job-detail { margin-top: 10px; font-size: 14px; color: #333; }
        .job-info { font-size: 12px; color: #666; margin-top: 8px; line-height: 1.6; }
        
        .action-select { width: 100%; margin-top: 12px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; font-family: inherit; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); 
                    display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:10px; color:var(--primary); font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
</div>

<div class="header">
    <h2 style="margin:0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
    <p id="adminName" style="margin:5px 0 0; font-size:14px; opacity:0.9;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•...</p>
</div>

<div class="filter-section">
    <label style="font-size:14px; font-weight:bold;">‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å:</label>
    <select id="prefixFilter" onchange="filterJobs()">
        <option value="ALL">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    </select>
</div>

<div id="jobContainer">
    </div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxJetfL-YG4QMZtk6SVaWoGQpelo7QX3WcAr302FTf6Xr438UdBQR6GonEBjP9o4Wi-/exec";
    const LIFF_ID = "2008875334-VPUmuC8D"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    let allJobs = [];
    let currentAdminUid = "";

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                currentAdminUid = profile.userId;
                document.getElementById('adminName').innerText = "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: " + profile.displayName;
                
                await loadPrefixes();
                await loadJobs();
            }
        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        }
    }

    // ‡πÇ‡∏´‡∏•‡∏î Prefix ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    async function loadPrefixes() {
        try {
            const res = await fetch(`${WEB_APP_URL}?action=getPrefixes`);
            const prefixes = await res.json();
            const select = document.getElementById('prefixFilter');
            prefixes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });
        } catch (e) { console.error("Load Prefixes failed"); }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
    async function loadJobs() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`${WEB_APP_URL}?action=getAllJobs`);
            allJobs = await res.json();
            renderJobs(allJobs);
        } catch (err) {
            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderJobs(jobs) {
        const container = document.getElementById('jobContainer');
        container.innerHTML = "";

        if (jobs.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</p>";
            return;
        }

        jobs.forEach(job => {
            const card = document.createElement('div');
            card.className = `job-card priority-${job.priority}`;
            
            const badgeClass = job.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'badge-pending' : 'badge-process';
            
            card.innerHTML = `
                <span class="ticket-id">#${job.ticketId}</span>
                <span class="status-badge ${badgeClass}">${job.status}</span>
                <div class="job-detail"><strong>${job.issue}</strong></div>
                <div class="job-info">
                    üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${job.room}<br>
                    üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${job.name}<br>
                    ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${job.timeStr}<br>
                    üõ† ‡∏ä‡πà‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•: ${job.adminName}
                </div>
                <select class="action-select" onchange="updateJobStatus(${job.row}, this.value)">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ --</option>
                    <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å">üöö ‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
                    <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß">üèÅ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">üîÑ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                </select>
            `;
            container.appendChild(card);
        });
    }

    async function updateJobStatus(row, newStatus) {
        if (!newStatus) return;
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}" ?`)) {
            loadJobs(); // Reset select
            return;
        }

        document.getElementById('loading').style.display = 'flex';
        try {
            // ‡∏™‡πà‡∏á Parameter ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: action, row, status ‡πÅ‡∏•‡∏∞ adminUid
            const res = await fetch(`${WEB_APP_URL}?action=adminUpdate&row=${row}&status=${encodeURIComponent(newStatus)}&adminUid=${currentAdminUid}`);
            const text = await res.text();
            
            if (text === "SUCCESS") {
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                await loadJobs();
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
            }
        } catch (e) {
            alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function filterJobs() {
        const prefix = document.getElementById('prefixFilter').value;
        if (prefix === "ALL") {
            renderJobs(allJobs);
        } else {
            const filtered = allJobs.filter(j => j.ticketId.startsWith(prefix));
            renderJobs(filtered);
        }
    }

    main();
</script>

</body>
</html>
