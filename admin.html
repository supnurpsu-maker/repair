<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - IT Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #000080; --bg: #f4f7f9; --urgent: #e74c3c; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
        .job-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 6px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .prio-‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î { border-left-color: var(--urgent); background: #fff5f5; }
        .prio-‡∏î‡πà‡∏ß‡∏ô { border-left-color: #f39c12; }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; }
        .filter-section { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chip { padding: 6px 15px; background: white; border-radius: 20px; border: 1px solid #ddd; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-update { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; margin-top: 10px; font-weight: 600; }
        #loader { text-align: center; padding: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0">Admin Dashboard</h2>
        <small id="adminDeptInfo">Checking Permission...</small>
    </div>

    <div id="superAdminTools" style="display:none;">
        <div class="filter-section" id="filterArea">
            <div class="chip active" onclick="filterJobs('ALL', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</div>
        </div>
    </div>

    <div id="loader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</div>
    <div id="jobList"></div>
</div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbweRBQCynTIY9etsQThAOXpZDlSr4q7wnme3gWi3F7tgk-958wwdHKiYFLCfkik1ozV/exec";
    const LIFF_ID = "2008875334-VPUmuC8D";
    let allJobs = [];
    let myRole = ""; 
    let myDept = "";
    let myUid = "";

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            const profile = await liff.getProfile();
            myUid = profile.userId;
            
            const res = await fetch(`${URL_GAS}?action=getAdminRole&uid=${myUid}`);
            const data = await res.json();
            
            if (data.role === "GUEST") {
                document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h3>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h3></div>";
                return;
            }

            myRole = data.role;
            myDept = data.dept;
            document.getElementById('adminDeptInfo').innerText = `Admin: ${data.dept}`;

            if (myRole === "SUPER_ADMIN") {
                document.getElementById('superAdminTools').style.display = 'block';
                await loadPrefixes();
            }

            await loadAllJobs();
        } catch (e) { console.error(e); }
    }

    async function loadPrefixes() {
        const res = await fetch(`${URL_GAS}?action=getPrefixes`);
        const prefixes = await res.json();
        const area = document.getElementById('filterArea');
        prefixes.forEach(p => {
            const div = document.createElement('div');
            div.className = 'chip'; div.innerText = p;
            div.onclick = (e) => filterJobs(p, e.target);
            area.appendChild(div);
        });
    }

    async function loadAllJobs() {
        document.getElementById('loader').style.display = 'block';
        const res = await fetch(`${URL_GAS}?action=getAllJobs`);
        allJobs = await res.json();
        
        let displayJobs = (myRole === "DEPT_ADMIN") 
            ? allJobs.filter(j => j.ticketId.startsWith(myDept + "#")) 
            : allJobs;
        
        renderJobs(displayJobs);
        document.getElementById('loader').style.display = 'none';
    }

    function renderJobs(jobs) {
        const container = document.getElementById('jobList');
        container.innerHTML = jobs.length === 0 ? "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>" : "";
        
        jobs.forEach(job => {
            const card = document.createElement('div');
            card.className = `job-card prio-${job.priority}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong style="color:var(--primary); font-size:16px;">${job.ticketId}</strong>
                        <div class="status-badge">${job.priority}</div>
                    </div>
                    <small style="color:#999">${job.timeStr}</small>
                </div>
                <div style="margin:10px 0; font-size:14px;">
                    üìç ${job.room} | üë§ ${job.name}<br>
                    üîß ${job.issue}<br>
                    <span style="color:blue; font-size:12px;">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ${job.adminName}</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="stat-${job.row}" style="flex:1.2; padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Reset)</option>
                        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å" ${job.status == '‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'selected' : ''}>‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
                        <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô)</option>
                    </select>
                    <button class="btn-update" style="flex:0.8; margin-top:0;" onclick="updateJob(${job.row})">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function updateJob(row) {
        const status = document.getElementById(`stat-${row}`).value;
        if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status}?`)) return;

        try {
            const res = await fetch(`${URL_GAS}?action=adminUpdate&row=${row}&status=${encodeURIComponent(status)}&adminUid=${myUid}`);
            if (await res.text() === "SUCCESS") {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
                loadAllJobs();
            }
        } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
    }

    function filterJobs(p, el) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        renderJobs((p === 'ALL') ? allJobs : allJobs.filter(j => j.ticketId.startsWith(p + "#")));
    }

    init();
</script>
</body>
</html>
