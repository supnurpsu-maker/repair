<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - IT Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #000080; --bg: #f4f7f9; --urgent: #e74c3c; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
        .job-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 6px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .prio-‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î { border-left-color: var(--urgent); background: #fff8f8; }
        .prio-‡∏î‡πà‡∏ß‡∏ô { border-left-color: #f39c12; }
        .prio-‡∏õ‡∏Å‡∏ï‡∏¥ { border-left-color: #3498db; }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; margin-top: 5px; display: inline-block; }
        .filter-section { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chip { padding: 6px 15px; background: white; border-radius: 20px; border: 1px solid #ddd; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-update { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; margin-top: 10px; font-weight: 600; cursor: pointer; }
        #loader { text-align: center; padding: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0">Admin Dashboard</h2>
        <small id="adminDeptInfo">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</small>
    </div>

    <div id="superAdminTools" style="display:none;">
        <div class="filter-section" id="filterArea">
            <div class="chip active" onclick="filterJobs('ALL', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</div>
        </div>
    </div>

    <div id="loader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</div>
    <div id="jobList"></div>
</div>

<script>
    // ** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL_GAS ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
    const URL_GAS = "https://script.google.com/macros/s/AKfycbzwsFNi_iku3c2L9NRsk2ZTInu8ojuUf8HX06zqMn_Ab8SqmPs02fVesWMQAsC8SnEa/exec";
    const LIFF_ID = "2008875334-VPUmuC8D";
    let allJobs = [];
    let myRole = ""; 
    let myDept = "";
    let myUid = "";

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            const profile = await liff.getProfile();
            myUid = profile.userId;
            
            const res = await fetch(`${URL_GAS}?action=getAdminRole&uid=${myUid}`);
            const data = await res.json();
            
            if (data.role === "GUEST") {
                document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h3>‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3></div>";
                return;
            }

            myRole = data.role;
            myDept = data.dept;
            document.getElementById('adminDeptInfo').innerText = `Admin: ${data.dept}`;

            if (myRole === "SUPER_ADMIN") {
                document.getElementById('superAdminTools').style.display = 'block';
                await loadPrefixes();
            }

            await loadAllJobs();
        } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: " + e); }
    }

    async function loadPrefixes() {
        try {
            const res = await fetch(`${URL_GAS}?action=getPrefixes`);
            const prefixes = await res.json();
            const area = document.getElementById('filterArea');
            prefixes.forEach(p => {
                const div = document.createElement('div');
                div.className = 'chip'; div.innerText = p;
                div.onclick = (e) => filterJobs(p, e.target);
                area.appendChild(div);
            });
        } catch (e) { console.error(e); }
    }

    async function loadAllJobs() {
        document.getElementById('loader').style.display = 'block';
        try {
            const res = await fetch(`${URL_GAS}?action=getAllJobs`);
            allJobs = await res.json();
            
            let displayJobs = (myRole === "DEPT_ADMIN") 
                ? allJobs.filter(j => j.ticketId.startsWith(myDept + "#")) 
                : allJobs;
            
            renderJobs(displayJobs);
        } catch (e) { document.getElementById('jobList').innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
        document.getElementById('loader').style.display = 'none';
    }

    function renderJobs(jobs) {
        const container = document.getElementById('jobList');
        container.innerHTML = jobs.length === 0 ? "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</p>" : "";
        
        jobs.forEach(job => {
            const card = document.createElement('div');
            card.className = `job-card prio-${job.priority}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong style="color:var(--primary); font-size:16px;">${job.ticketId}</strong><br>
                        <div class="status-badge">${job.priority}</div>
                    </div>
                    <small style="color:#999">${job.timeStr}</small>
                </div>
                <div style="margin:10px 0; font-size:14px; line-height:1.6;">
                    üìç <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${job.room}<br>
                    üë§ <b>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</b> ${job.name}<br>
                    üîß <b>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${job.issue}<br>
                    <span style="color:blue; font-size:12px;">üë§ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ${job.adminName}</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="stat-${job.row}" style="flex:1.5; padding:8px; border-radius:8px; border:1px solid #ddd; font-size:13px;">
                        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${job.status == '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å" ${job.status == '‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'selected' : ''}>‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
                        <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                    </select>
                    <button class="btn-update" style="flex:0.8; margin-top:0;" onclick="updateJob(${job.row})">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function updateJob(row) {
        const status = document.getElementById(`stat-${row}`).value;
        if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}"?`)) return;

        try {
            const res = await fetch(`${URL_GAS}?action=adminUpdate&row=${row}&status=${encodeURIComponent(status)}&adminUid=${myUid}`);
            const result = await res.text();
            if (result === "SUCCESS") {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
                await loadAllJobs(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô (‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result);
            }
        } catch (e) { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ"); }
    }

    function filterJobs(p, el) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        const filtered = (p === 'ALL') ? allJobs : allJobs.filter(j => j.ticketId.startsWith(p + "#"));
        renderJobs(filtered);
    }

    init();
</script>
</body>
</html>
