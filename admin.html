<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #000080; --accent: #FBCEB1; --bg: #f4f7fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #filterArea { display: none; background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #prefixFilter { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .job-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-left: 6px solid #ccc; }
        .priority-‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î { border-left-color: #ff4d4d; }
        .priority-‡∏î‡πà‡∏ß‡∏ô { border-left-color: #ffa500; }
        .priority-‡∏õ‡∏Å‡∏ï‡∏¥ { border-left-color: #2ecc71; }
        .ticket-id { font-weight: bold; color: var(--primary); }
        .status-badge { float: right; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-pending { background: #fff5f5; color: #ff4d4d; border: 1px solid #ff4d4d; }
        .badge-process { background: #e8f0fe; color: #000080; border: 1px solid #000080; }
        .job-detail { margin-top: 10px; font-size: 14px; color: #333; }
        .job-info { font-size: 12px; color: #666; margin-top: 8px; line-height: 1.6; }
        .action-select { width: 100%; margin-top: 12px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; font-family: inherit; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</p></div>

<div class="header">
    <h2 style="margin:0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
    <p id="adminName" style="margin:5px 0 0; font-size:14px; opacity:0.9;">Loading...</p>
</div>

<div id="filterArea">
    <label style="font-size:14px; font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å:</label>
    <select id="prefixFilter" onchange="filterJobs()"><option value="ALL">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
</div>

<div id="jobContainer"></div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1GalQrQlPR2uhUNvfBg--VWFqr1zxh1sYK2eE3df4h5-JECDCy8UO3sp0lYnf73A/exec";
    const LIFF_ID = "2008875334-VPUmuC8D";

    let allJobs = [];
    let currentAdminUid = "";
    let adminDept = "";

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            currentAdminUid = profile.userId;
            
            const authRes = await fetch(`${WEB_APP_URL}?action=getAdminRole&uid=${currentAdminUid}`);
            const authData = await authRes.json();
            
            if (authData.role === "GUEST") {
                document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>";
                return;
            }

            adminDept = authData.dept; 
            document.getElementById('adminName').innerText = `‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ${profile.displayName} (${adminDept})`;

            if (adminDept.toLowerCase() === "admin") {
                document.getElementById('filterArea').style.display = 'flex';
                await loadPrefixes(); 
            }

            await loadJobs();
        } catch (err) { alert("Error: " + err.message); }
    }

    async function loadPrefixes() {
        try {
            const res = await fetch(`${WEB_APP_URL}?action=getPrefixes`);
            const prefixes = await res.json();
            const select = document.getElementById('prefixFilter');
            prefixes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.innerText = p; select.appendChild(opt);
            });
        } catch (e) { console.error(e); }
    }

    async function loadJobs() {
        document.getElementById('loadingText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...";
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`${WEB_APP_URL}?action=getAllJobs`);
            allJobs = await res.json();
            filterJobs(); 
        } catch (err) { alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

   // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö data-admin-uid ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
function renderJobs(jobs) {
    const container = document.getElementById('jobContainer');
    container.innerHTML = jobs.length === 0 ? "<p style='text-align:center; color:#999; margin-top:50px;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</p>" : "";

    jobs.forEach(job => {
        const card = document.createElement('div');
        card.className = `job-card priority-${job.priority}`;
        // ‡πÄ‡∏Å‡πá‡∏ö UID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô attribute (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        card.setAttribute('data-responsible-uid', job.responsibleUid || ""); 
        
        const badgeClass = job.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'badge-pending' : 'badge-process';
        
        card.innerHTML = `
            <span class="ticket-id">#${job.ticketId}</span>
            <span class="status-badge ${badgeClass}">${job.status}</span>
            <div class="job-detail"><strong>${job.issue}</strong></div>
            <div class="job-info">
                üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${job.room}<br>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${job.name}<br>
                ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${job.timeStr}<br>üõ† ‡∏ä‡πà‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•: ${job.adminName}
            </div>
            <select class="action-select" onchange="updateJobStatus(${job.row}, this.value)">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ --</option>
                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å">üöö ‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
                <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß">üèÅ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">üîÑ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            </select>
        `;
        container.appendChild(card);
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° UID
function filterJobs() {
    const prefix = (adminDept.toLowerCase() === "admin") 
                   ? document.getElementById('prefixFilter').value 
                   : adminDept;

    let filtered = allJobs;

    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å (Prefix)
    if (prefix !== "ALL") {
        filtered = filtered.filter(j => j.ticketId.split('#')[0] === prefix);
    }

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (UID Lock)
    filtered = filtered.filter(job => {
        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
        if (job.status === "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£") return true;

        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super Admin (‡πÅ‡∏ú‡∏ô‡∏Å admin) ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        if (adminDept.toLowerCase() === "admin") return true;

        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 3: ‡∏ñ‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (job.responsibleUid ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤) 
        // ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ UID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        return job.responsibleUid === currentAdminUid;
    });

    renderJobs(filtered);
}

    async function updateJobStatus(row, newStatus) {
        if (!newStatus) return;
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}" ?`)) {
            loadJobs();
            return;
        }
        document.getElementById('loadingText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...";
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`${WEB_APP_URL}?action=adminUpdate&row=${row}&status=${encodeURIComponent(newStatus)}&adminUid=${currentAdminUid}`);
            if (await res.text() === "SUCCESS") {
                await loadJobs();
            }
        } catch (e) { alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    main();
</script>
</body>
</html>
