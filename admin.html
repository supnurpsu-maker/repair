<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Support Admin Dashboard</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; margin: 0; padding: 15px; }
        .header { background: #007bff; color: white; padding: 20px; border-radius: 0 0 15px 15px; margin: -15px -15px 20px -15px; text-align: center; }
        .job-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 6px solid #ccc; position: relative; }
        .job-card.ongoing { border-left-color: #ffc107; }
        .ticket-id { font-weight: bold; color: #007bff; font-size: 1.1em; }
        .status-badge { position: absolute; top: 15px; right: 15px; font-size: 11px; background: #eee; padding: 3px 10px; border-radius: 12px; }
        .info { font-size: 14px; margin: 8px 0; color: #333; }
        .issue-box { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 14px; border: 1px solid #eee; margin: 10px 0; }
        .admin-name { font-size: 12px; color: #999; }
        .btn-group { display: flex; gap: 8px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-start { background: #007bff; color: white; }
        .btn-done { background: #28a745; color: white; }
        #loading { text-align: center; padding-top: 50px; color: #666; }
    </style>
</head>
<body>

<div id="loading">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà...</div>

<div id="adminApp" style="display:none;">
    <div class="header">
        <h2 style="margin:0">Admin IT Dashboard</h2>
        <p id="adminInfo" style="margin:5px 0 0; opacity:0.9; font-size:14px;"></p>
    </div>
    <div id="jobList"></div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyhFjRFLD8IHvfDw6-tmYKAHn8xSoHHdPUbcg8oHT3MFtIxV7KG_K72gMaYdjMbfzO/exec";
    const LIFF_ID = "2008875334-VPUmuC8D";
    let myUid = "";

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            myUid = profile.userId;

            const res = await fetch(`${WEB_APP_URL}?action=checkAdmin&uid=${myUid}`);
            const auth = await res.json();

            if (auth.isAdmin) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("adminApp").style.display = "block";
                document.getElementById("adminInfo").innerText = `‡∏Ñ‡∏∏‡∏ì ${auth.name} | ‡πÅ‡∏ú‡∏ô‡∏Å: ${auth.dept}`;
                loadJobs();
            } else {
                document.getElementById("loading").innerHTML = "<h3>‚ùå ‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h3>";
            }
        } catch (e) { alert("Error: " + e); }
    }

    async function loadJobs() {
        const listDiv = document.getElementById("jobList");
        listDiv.innerHTML = "<p style='text-align:center; color:#999;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</p>";
        
        const res = await fetch(`${WEB_APP_URL}?action=listPending&uid=${myUid}`);
        const jobs = await res.json();
        
        listDiv.innerHTML = jobs.length === 0 ? "<p style='text-align:center; padding:50px; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>" : "";

        jobs.forEach(job => {
            const isOngoing = job.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
            listDiv.innerHTML += `
                <div class="job-card ${isOngoing ? 'ongoing' : ''}">
                    <span class="status-badge">${job.status}</span>
                    <span class="ticket-id">${job.ticketId}</span>
                    <div class="info">
                        <b>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</b> ${job.name} | <b>‡∏´‡πâ‡∏≠‡∏á:</b> ${job.room}<br>
                        <b>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</b> ${job.category} | <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô:</b> ${job.priority}
                    </div>
                    <div class="issue-box"><b>‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</b> ${job.issue}</div>
                    <div class="admin-name">${job.adminName ? 'üõ† ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÇ‡∏î‡∏¢: ' + job.adminName : '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô'}</div>
                    <div class="btn-group">
                        <button class="btn-start" onclick="updateStatus(${job.row}, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
                        <button class="btn-done" onclick="updateStatus(${job.row}, '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
            `;
        });
    }

    async function updateStatus(row, status) {
        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        const res = await fetch(`${WEB_APP_URL}?action=updateStatus&row=${row}&status=${status}&uid=${myUid}`);
        if (await res.text() === "OK") loadJobs();
    }

    init();
</script>
</body>
</html>
