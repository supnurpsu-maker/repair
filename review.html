<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 100px; background: #f4f7fa; color: #000080; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #000080; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="status">
        <h2>กำลังบันทึกคะแนนความพึงพอใจ...</h2>
        <div class="loader"></div>
    </div>

    <script>
        const URL_GAS = "https://script.google.com/macros/s/AKfycbxFRuQZwtPWWP9O3PrvAVRWfTvmpsUa5H5H0HxdADWqIgu49hxXahXHzTEfKsVZGzEz/exec";
        
        async function submitRating(score) {
            const row = new URLSearchParams(window.location.search).get('row');
            
            // แสดง Loading
            document.getElementById('loader').style.display = 'block';
        
            try {
                const res = await fetch(`${URL_GAS}?action=submitReview&row=${row}&score=${score}`);
                const result = await res.text();
        
                if (result === "OK") {
                    alert("ขอบคุณสำหรับคะแนนประเมินครับ");
                    liff.closeWindow(); // ปิดหน้าต่าง LIFF
                } else if (result === "ERROR_NOT_FINISHED") {
                    alert("❌ ไม่สามารถประเมินได้: เนื่องจากงานนี้ยังดำเนินการไม่เสร็จสิ้น");
                } else if (result === "ERROR_ALREADY_RATED") {
                    alert("⚠️ คุณได้ทำการประเมินรายการนี้ไปแล้ว");
                    liff.closeWindow();
                } else {
                    alert("เกิดข้อผิดพลาด: " + result);
                }
            } catch (e) {
                alert("การเชื่อมต่อล้มเหลว");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }
        submitReview();
    </script>
</body>
</html>
